@model Invoice_automation_V1.ViewModels.CreateInvoiceViewModel
@{
    ViewData["Title"] = "Upload New Invoice";
}

<!-- Breadcrumb -->
<nav class="mb-4">
    <ol class="flex items-center gap-2 text-sm">
        <li><a asp-action="Index" class="text-gray-400 hover:text-blue-600 transition-colors">Invoices</a></li>
        <li class="text-gray-300"><i class="bi bi-chevron-right text-xs"></i></li>
        <li class="text-gray-700 font-medium">Upload New Invoice</li>
    </ol>
</nav>

<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 tracking-tight flex items-center gap-2.5">
            <span class="inline-flex items-center justify-center w-9 h-9 rounded-xl bg-blue-600 text-white shadow-sm">
                <i class="bi bi-cloud-upload text-base"></i>
            </span>
            Upload New Invoice
        </h1>
        <p class="mt-1 text-sm text-gray-500">Upload an invoice file to process with OCR</p>
    </div>
    <a asp-action="Index"
       class="inline-flex items-center gap-2 px-4 py-2.5 border border-gray-200 text-gray-600 text-sm font-medium rounded-xl hover:bg-gray-50 transition-colors">
        <i class="bi bi-arrow-left"></i> Back to List
    </a>
</div>

<div class="max-w-2xl mx-auto">
    <form asp-action="Create" method="post" enctype="multipart/form-data" id="uploadForm">
        <div asp-validation-summary="ModelOnly" class="mb-4 flex items-start gap-3 p-4 bg-red-50 border border-red-100 rounded-xl text-sm text-red-700"></div>

        <!-- Company Selection -->
        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden mb-4">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-sm font-semibold text-gray-800 flex items-center gap-2">
                    <i class="bi bi-building text-gray-400"></i> Company
                </h3>
            </div>
            <div class="p-5">
                <label asp-for="CompanyId" class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">
                    Select Company <span class="text-red-500">*</span>
                </label>
                <select asp-for="CompanyId" class="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm text-gray-800 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 transition-colors" asp-items="ViewBag.Companies" id="companySelect">
                </select>
                <span asp-validation-for="CompanyId" class="block mt-1 text-xs text-red-500"></span>
            </div>
        </div>

        <!-- File Upload -->
        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden mb-4">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-sm font-semibold text-gray-800 flex items-center gap-2">
                    <i class="bi bi-file-earmark-arrow-up text-gray-400"></i> Invoice File
                </h3>
            </div>
            <div class="p-5">
                <!-- Drop Zone -->
                <div id="dropZone"
                     class="border-2 border-dashed border-gray-200 rounded-2xl p-10 text-center cursor-pointer transition-all hover:border-blue-400 hover:bg-blue-50/30">
                    <div class="flex flex-col items-center">
                        <div class="w-14 h-14 rounded-2xl bg-blue-50 flex items-center justify-center mb-4">
                            <i class="bi bi-cloud-arrow-up text-3xl text-blue-500"></i>
                        </div>
                        <p class="text-sm font-semibold text-gray-700 mb-1">Drag & drop your invoice here</p>
                        <p class="text-xs text-gray-400 mb-4">or click to browse files</p>
                        <input type="file" asp-for="InvoiceFile" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.tif,.tiff" id="invoiceFileInput">
                        <button type="button"
                                class="inline-flex items-center gap-2 px-4 py-2 border border-blue-200 bg-blue-50 text-blue-600 text-xs font-semibold rounded-lg hover:bg-blue-100 transition-colors"
                                id="browseBtn">
                            <i class="bi bi-folder2-open"></i> Browse Files
                        </button>
                        <p class="mt-3 text-xs text-gray-400">PDF, JPG, PNG, TIF &mdash; Max 10 MB</p>
                    </div>
                </div>
                <span asp-validation-for="InvoiceFile" class="block mt-1 text-xs text-red-500"></span>

                <!-- File Preview -->
                <div id="filePreview" class="hidden mt-4">
                    <div class="flex items-center gap-4 p-4 bg-emerald-50 border border-emerald-100 rounded-xl">
                        <div class="w-10 h-10 rounded-xl bg-emerald-100 flex items-center justify-center flex-shrink-0">
                            <i class="bi bi-file-earmark-check text-xl text-emerald-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p id="fileName" class="text-sm font-semibold text-gray-800 truncate"></p>
                            <p id="fileSize" class="text-xs text-gray-500 mt-0.5"></p>
                        </div>
                        <button type="button"
                                class="flex-shrink-0 inline-flex items-center justify-center w-7 h-7 rounded-lg border border-red-100 bg-red-50 text-red-500 hover:bg-red-100 transition-colors"
                                id="removeFile">
                            <i class="bi bi-x-lg text-xs"></i>
                        </button>
                    </div>
                </div>

                <div class="border-t border-gray-100 mt-5 pt-4">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" asp-for="ProcessWithOcr" id="processOcrSwitch"
                               class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500/30" checked>
                        <div>
                            <span class="text-sm font-semibold text-gray-800">Process with OCR automatically</span>
                            <p class="text-xs text-gray-400 mt-0.5">
                                Extracts invoice number, dates, vendor, amounts, and line items.
                            </p>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Pre-fill Details (collapsed) -->
        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden mb-4">
            <div class="px-6 py-4 cursor-pointer hover:bg-gray-50/50 transition-colors" data-bs-toggle="collapse" data-bs-target="#manualDetails">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-gray-800 flex items-center gap-2">
                        <i class="bi bi-pencil-square text-gray-400"></i>
                        Pre-fill Details
                        <span class="text-xs font-normal text-gray-400">(optional)</span>
                    </h3>
                    <i class="bi bi-chevron-down text-gray-400 text-sm"></i>
                </div>
            </div>
            <div class="collapse" id="manualDetails">
                <div class="px-5 pb-5 border-t border-gray-100 pt-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label asp-for="VendorId" class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Vendor</label>
                            <select asp-for="VendorId" class="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm text-gray-800 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500" asp-items="ViewBag.Vendors" id="vendorSelect">
                                <option value="">-- OCR will match vendor --</option>
                            </select>
                        </div>
                        <div>
                            <label asp-for="InvoiceNumber" class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Invoice Number</label>
                            <input asp-for="InvoiceNumber" class="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500" placeholder="OCR will extract this">
                        </div>
                        <div>
                            <label asp-for="InvoiceDate" class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Invoice Date</label>
                            <input asp-for="InvoiceDate" type="date" class="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500">
                        </div>
                        <div>
                            <label asp-for="DueDate" class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Due Date</label>
                            <input asp-for="DueDate" type="date" class="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label asp-for="Description" class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Description</label>
                            <textarea asp-for="Description" class="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 resize-none" rows="2" placeholder="Brief description..."></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label asp-for="Notes" class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Notes</label>
                            <textarea asp-for="Notes" class="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 resize-none" rows="2" placeholder="Additional notes..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- How it works -->
        <div class="flex items-start gap-3 p-4 bg-blue-50 border border-blue-100 rounded-xl text-sm mb-5">
            <i class="bi bi-lightbulb text-blue-500 flex-shrink-0 text-base mt-0.5"></i>
            <div>
                <p class="font-semibold text-blue-800 mb-1">How it works</p>
                <ol class="text-xs text-blue-700 space-y-0.5 list-decimal list-inside">
                    <li>Upload your invoice file (PDF or image)</li>
                    <li>OCR automatically extracts invoice number, dates, vendor, amounts &amp; line items</li>
                    <li>Review and correct extracted data on the invoice details page</li>
                    <li>Assign chart of accounts and submit for approval</li>
                </ol>
            </div>
        </div>

        <!-- Submit -->
        <div class="flex items-center justify-end gap-3">
            <a asp-action="Index"
               class="px-5 py-2.5 border border-gray-200 text-gray-600 text-sm font-medium rounded-xl hover:bg-gray-50 transition-colors">
                Cancel
            </a>
            <button type="submit" id="submitBtn"
                    class="inline-flex items-center gap-2 px-6 py-2.5 bg-blue-600 text-white text-sm font-semibold rounded-xl hover:bg-blue-700 active:bg-blue-800 transition-all shadow-sm hover:shadow-md">
                <i class="bi bi-cloud-upload"></i> Upload &amp; Process
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        var dropZone = document.getElementById('dropZone');
        var fileInput = document.getElementById('invoiceFileInput');
        var browseBtn = document.getElementById('browseBtn');
        var filePreview = document.getElementById('filePreview');
        var removeFileBtn = document.getElementById('removeFile');

        browseBtn.addEventListener('click', function() { fileInput.click(); });
        dropZone.addEventListener('click', function(e) {
            if (e.target !== browseBtn && !browseBtn.contains(e.target)) fileInput.click();
        });

        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropZone.classList.add('border-blue-400', 'bg-blue-50');
        });
        dropZone.addEventListener('dragleave', function() {
            dropZone.classList.remove('border-blue-400', 'bg-blue-50');
        });
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropZone.classList.remove('border-blue-400', 'bg-blue-50');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                showFilePreview(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', function(e) {
            if (e.target.files[0]) showFilePreview(e.target.files[0]);
        });

        removeFileBtn.addEventListener('click', function() {
            fileInput.value = '';
            filePreview.classList.add('hidden');
            dropZone.style.display = '';
        });

        function showFilePreview(file) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            filePreview.classList.remove('hidden');
            dropZone.style.display = 'none';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            var k = 1024;
            var sizes = ['Bytes', 'KB', 'MB', 'GB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        document.getElementById('companySelect').addEventListener('change', function() {
            var companyId = this.value;
            var vendorSelect = document.getElementById('vendorSelect');
            vendorSelect.innerHTML = '<option value="">-- OCR will match vendor --</option>';
            if (!companyId) return;
            fetch('@Url.Action("GetVendorsByCompany", "Invoice")?companyId=' + companyId)
                .then(function(r) { return r.json(); })
                .then(function(vendors) {
                    vendors.forEach(function(v) {
                        var opt = document.createElement('option');
                        opt.value = v.id;
                        opt.textContent = v.name;
                        vendorSelect.appendChild(opt);
                    });
                })
                .catch(function(err) { console.error('Error loading vendors:', err); });
        });

        document.getElementById('uploadForm').addEventListener('submit', function() {
            var btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Uploading...';
        });
    </script>
}
