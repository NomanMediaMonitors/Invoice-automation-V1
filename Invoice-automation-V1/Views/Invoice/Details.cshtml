@model Invoice_automation_V1.ViewModels.InvoiceDetailsViewModel
@{
    ViewData["Title"] = "Invoice Details";
    var canEdit = Model.Status != "Paid" && !Model.SyncedToIndraajAt.HasValue;
    var canApprove = Model.Status == "Draft" || Model.Status == "PendingApproval";
    var canPay = Model.Status == "Approved";
    var canSync = (Model.Status == "Approved" || Model.Status == "Paid") && !Model.SyncedToIndraajAt.HasValue;
}

@Html.AntiForgeryToken()
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="bi bi-receipt"></i> Invoice Details
        </h2>
        <div class="btn-group">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
            @if (canEdit)
            {
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-primary">
                    <i class="bi bi-pencil"></i> Edit
                </a>
            }
        </div>
    </div>

    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Invoice Header Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Invoice: @Model.InvoiceNumber</h4>
                    <span class="badge bg-@(Model.Status switch { "Draft" => "secondary", "PendingApproval" => "warning", "Approved" => "success", "Rejected" => "danger", "Paid" => "primary", _ => "secondary" }) fs-6">
                        @Model.Status
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-muted mb-3">Vendor Information</h5>
                            <p class="mb-1"><strong>@Model.VendorName</strong></p>
                            <p class="mb-1 text-muted">
                                <i class="bi bi-envelope"></i> @Model.VendorEmail
                            </p>
                            @if (!string.IsNullOrEmpty(Model.VendorPhone))
                            {
                                <p class="mb-1 text-muted">
                                    <i class="bi bi-telephone"></i> @Model.VendorPhone
                                </p>
                            }
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-muted mb-3">Invoice Dates</h5>
                            <p class="mb-1">
                                <strong>Invoice Date:</strong> @Model.InvoiceDate.ToString("MMMM dd, yyyy")
                            </p>
                            @if (Model.DueDate.HasValue)
                            {
                                <p class="mb-1 @(Model.IsOverdue ? "text-danger" : "")">
                                    <strong>Due Date:</strong> @Model.DueDate.Value.ToString("MMMM dd, yyyy")
                                    @if (Model.IsOverdue)
                                    {
                                        <span class="badge bg-danger">OVERDUE</span>
                                    }
                                    else if (Model.DaysUntilDue <= 7 && Model.DaysUntilDue > 0)
                                    {
                                        <span class="badge bg-warning">Due in @Model.DaysUntilDue days</span>
                                    }
                                </p>
                            }
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <hr>
                        <h5 class="text-muted mb-2">Description</h5>
                        <p class="mb-0">@Model.Description</p>
                    }

                    @if (!string.IsNullOrEmpty(Model.Notes))
                    {
                        <hr>
                        <h5 class="text-muted mb-2">Notes</h5>
                        <p class="mb-0">@Model.Notes</p>
                    }
                </div>
            </div>

            <!-- Line Items Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Line Items</h5>
                    @if (Model.LineItems.Any() && canEdit)
                    {
                        <small class="text-muted">Assign chart of accounts to categorize expenses</small>
                    }
                </div>
                <div class="card-body">
                    @if (Model.LineItems.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Description</th>
                                        <th>Account</th>
                                        <th class="text-end">Qty</th>
                                        <th class="text-end">Unit Price</th>
                                        <th class="text-end">Amount</th>
                                        <th class="text-end">Tax</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.LineItems)
                                    {
                                        <tr>
                                            <td>@item.LineNumber</td>
                                            <td>
                                                @item.Description
                                                @if (item.IsOcrExtracted)
                                                {
                                                    <span class="badge bg-info text-white ms-2" title="Extracted by OCR">OCR</span>
                                                }
                                            </td>
                                            <td>
                                                @if (canEdit)
                                                {
                                                    <select class="form-select form-select-sm account-select"
                                                            data-line-item-id="@item.Id"
                                                            style="min-width: 180px;">
                                                        <option value="">-- Select --</option>
                                                        @if (ViewBag.ChartOfAccounts != null)
                                                        {
                                                            @foreach (var account in (List<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>)ViewBag.ChartOfAccounts)
                                                            {
                                                                <option value="@account.Value"
                                                                        selected="@(item.ChartOfAccountId?.ToString() == account.Value)">
                                                                    @account.Text
                                                                </option>
                                                            }
                                                        }
                                                    </select>
                                                }
                                                else if (!string.IsNullOrEmpty(item.AccountCode))
                                                {
                                                    <small class="text-muted">@item.AccountCode - @item.AccountName</small>
                                                }
                                                else
                                                {
                                                    <small class="text-muted">Not assigned</small>
                                                }
                                            </td>
                                            <td class="text-end">@item.Quantity.ToString("N2")</td>
                                            <td class="text-end">@Model.Currency @item.UnitPrice.ToString("N2")</td>
                                            <td class="text-end">@Model.Currency @item.Amount.ToString("N2")</td>
                                            <td class="text-end">@Model.Currency @item.TaxAmount.ToString("N2")</td>
                                            <td class="text-end fw-bold">@Model.Currency @item.TotalAmount.ToString("N2")</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="7" class="text-end"><strong>Subtotal:</strong></td>
                                        <td class="text-end fw-bold">@Model.Currency @Model.SubTotal.ToString("N2")</td>
                                    </tr>
                                    <tr>
                                        <td colspan="7" class="text-end"><strong>Tax:</strong></td>
                                        <td class="text-end fw-bold">@Model.Currency @Model.TaxAmount.ToString("N2")</td>
                                    </tr>
                                    <tr class="table-primary">
                                        <td colspan="7" class="text-end"><strong>Total Amount:</strong></td>
                                        <td class="text-end fw-bold fs-5">@Model.Currency @Model.TotalAmount.ToString("N2")</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-inbox display-4"></i>
                            <p class="mt-2">No line items added yet</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Attached File Card -->
            @if (!string.IsNullOrEmpty(Model.FileUrl))
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-paperclip"></i> Attached File</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-file-earmark-pdf display-4 text-danger me-3"></i>
                            <div class="flex-grow-1">
                                <p class="mb-1 fw-bold">@Model.OriginalFileName</p>
                                <p class="mb-0 text-muted small">
                                    Size: @(Model.FileSize.HasValue ? (Model.FileSize.Value / 1024.0).ToString("N2") + " KB" : "Unknown")
                                </p>
                            </div>
                            <a href="@Model.FileUrl" target="_blank" class="btn btn-outline-primary">
                                <i class="bi bi-download"></i> Download
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Actions Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> Actions</h5>
                </div>
                <div class="card-body">
                    @if (canApprove)
                    {
                        <form asp-action="Approve" method="post" class="mb-2">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-success w-100" onclick="return confirm('Are you sure you want to approve this invoice?')">
                                <i class="bi bi-check-circle"></i> Approve Invoice
                            </button>
                        </form>
                        <form asp-action="Reject" method="post" class="mb-2">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Are you sure you want to reject this invoice?')">
                                <i class="bi bi-x-circle"></i> Reject Invoice
                            </button>
                        </form>
                    }

                    @if (canPay)
                    {
                        <button type="button" class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#paymentModal">
                            <i class="bi bi-currency-dollar"></i> Mark as Paid
                        </button>
                    }

                    @if (canSync)
                    {
                        <form asp-action="SyncToIndraaj" method="post" class="mb-2">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-info w-100" onclick="return confirm('Sync this invoice to Indraaj?')">
                                <i class="bi bi-cloud-arrow-up"></i> Sync to Indraaj
                            </button>
                        </form>
                    }

                    @if (!string.IsNullOrEmpty(Model.FileUrl))
                    {
                        <form asp-action="ProcessOcr" method="post" class="mb-2">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="bi bi-magic"></i> @(Model.IsOcrProcessed ? "Re-process with OCR" : "Process with OCR")
                            </button>
                        </form>
                    }

                    @if (canEdit)
                    {
                        <hr>
                        <form asp-action="Delete" method="post" onsubmit="return confirm('Are you sure you want to delete this invoice? This action cannot be undone.')">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="bi bi-trash"></i> Delete Invoice
                            </button>
                        </form>
                    }
                </div>
            </div>

            <!-- OCR Information Card -->
            @if (Model.IsOcrProcessed)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-robot"></i> OCR Information</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-2">
                            <strong>Status:</strong>
                            <span class="badge bg-success">Processed</span>
                        </p>
                        @if (Model.OcrProcessedAt.HasValue)
                        {
                            <p class="mb-2">
                                <strong>Processed:</strong> @Model.OcrProcessedAt.Value.ToString("MMM dd, yyyy HH:mm")
                            </p>
                        }
                        @if (Model.OcrConfidenceScore.HasValue)
                        {
                            <p class="mb-0">
                                <strong>Confidence:</strong> @Model.OcrConfidenceScore.Value.ToString("N2")%
                            </p>
                            <div class="progress mt-2" style="height: 20px;">
                                <div class="progress-bar @(Model.OcrConfidenceScore >= 80 ? "bg-success" : Model.OcrConfidenceScore >= 60 ? "bg-warning" : "bg-danger")"
                                     role="progressbar"
                                     style="width: @Model.OcrConfidenceScore%"
                                     aria-valuenow="@Model.OcrConfidenceScore"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    @Model.OcrConfidenceScore.Value.ToString("N0")%
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.OcrErrorMessage))
                        {
                            <div class="alert alert-warning mt-2 mb-0 py-1 px-2 small">
                                <i class="bi bi-exclamation-triangle"></i> @Model.OcrErrorMessage
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Approval Information -->
            @if (Model.ApprovedAt.HasValue)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-check-circle"></i> Approval Info</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-1"><strong>Approved By:</strong> @Model.ApprovedByName</p>
                        <p class="mb-1"><strong>Date:</strong> @Model.ApprovedAt.Value.ToString("MMM dd, yyyy HH:mm")</p>
                        @if (!string.IsNullOrEmpty(Model.ApprovalNotes))
                        {
                            <p class="mb-0"><strong>Notes:</strong> @Model.ApprovalNotes</p>
                        }
                    </div>
                </div>
            }

            <!-- Payment Information -->
            @if (Model.PaidAt.HasValue)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-currency-dollar"></i> Payment Info</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-1"><strong>Paid By:</strong> @Model.PaidByName</p>
                        <p class="mb-1"><strong>Date:</strong> @Model.PaidAt.Value.ToString("MMM dd, yyyy")</p>
                        <p class="mb-0"><strong>Reference:</strong> @Model.PaymentReference</p>
                    </div>
                </div>
            }

            <!-- Indraaj Sync Information -->
            @if (Model.SyncedToIndraajAt.HasValue)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-cloud-check"></i> Indraaj Sync</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-1"><strong>Voucher No:</strong> @Model.IndraajVoucherNo</p>
                        <p class="mb-0"><strong>Synced:</strong> @Model.SyncedToIndraajAt.Value.ToString("MMM dd, yyyy HH:mm")</p>
                    </div>
                </div>
            }

            <!-- Audit Information -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Audit Trail</h5>
                </div>
                <div class="card-body">
                    <p class="mb-1 small"><strong>Created By:</strong> @Model.CreatedByName</p>
                    <p class="mb-1 small"><strong>Created:</strong> @Model.CreatedAt.ToString("MMM dd, yyyy HH:mm")</p>
                    <p class="mb-0 small"><strong>Last Updated:</strong> @Model.UpdatedAt.ToString("MMM dd, yyyy HH:mm")</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="MarkAsPaid" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                <div class="modal-header">
                    <h5 class="modal-title">Mark Invoice as Paid</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Payment Date</label>
                        <input type="date" name="paymentDate" class="form-control" value="@DateTime.Today.ToString("yyyy-MM-dd")" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Reference</label>
                        <input type="text" name="paymentReference" class="form-control" placeholder="e.g., CHQ-123456" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Mark as Paid</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Inline chart of accounts assignment for line items
        document.querySelectorAll('.account-select').forEach(function(select) {
            select.addEventListener('change', function() {
                var lineItemId = this.dataset.lineItemId;
                var chartOfAccountId = this.value;

                fetch('@Url.Action("AssignLineItemAccount", "Invoice")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({
                        lineItemId: lineItemId,
                        chartOfAccountId: chartOfAccountId || null
                    })
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        select.classList.add('border-success');
                        setTimeout(function() { select.classList.remove('border-success'); }, 2000);
                    } else {
                        alert('Failed to assign account: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(function(error) {
                    console.error('Error assigning account:', error);
                });
            });
        });
    </script>
}

<style>
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }

    .table-bordered th,
    .table-bordered td {
        vertical-align: middle;
    }

    .account-select.border-success {
        border-color: #198754 !important;
        box-shadow: 0 0 0 0.15rem rgba(25, 135, 84, 0.25);
        transition: border-color 0.3s, box-shadow 0.3s;
    }
</style>
